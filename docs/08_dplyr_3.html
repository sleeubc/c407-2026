<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>dplyr 3</title>
    <meta charset="utf-8" />
    <meta name="author" content="Sanghoon Lee" />
    <script src="libs/header-attrs-2.29/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="c407_slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# dplyr 3
]
.author[
### Sanghoon Lee
]
.date[
### 11 January, 2026
]

---




Group_by() - mutate()

nth()

lag()

---

### group_by() - mutate()


``` r
library(tidyverse)
tb &lt;- tibble(a=c(1,1,1,2,2,2), b=c(1,2,3,3,4,4))
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```

---

.pull-left[

``` r
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```
]
.pull-right[

``` r
tb %&gt;% group_by(a) %&gt;% 
  summarise(b_1 = nth(b, 1))
```

```
# A tibble: 2 × 2
      a   b_1
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     2     3
```
]

---

.pull-left[

``` r
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```
]
.pull-right[

``` r
tb %&gt;% group_by(a) %&gt;% 
  mutate(b_1 = nth(b,1))
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b   b_1
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1     1
2     1     2     1
3     1     3     1
4     2     3     3
5     2     4     3
6     2     4     3
```
]

---

.pull-left-1[

``` r
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```
]
.pull-right-2[

``` r
tb %&gt;% group_by(a) %&gt;% 
  mutate(b_index = b/nth(b, 1))
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b b_index
  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1     1     1    1   
2     1     2    2   
3     1     3    3   
4     2     3    1   
5     2     4    1.33
6     2     4    1.33
```
]

---

### lag()

.pull-left[

``` r
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```
]

.pull-right[

``` r
tb %&gt;% mutate(lag_b = lag(b))
```

```
# A tibble: 6 × 3
      a     b lag_b
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    NA
2     1     2     1
3     1     3     2
4     2     3     3
5     2     4     3
6     2     4     4
```

]

---

.pull-left[

``` r
tb
```

```
# A tibble: 6 × 2
      a     b
  &lt;dbl&gt; &lt;dbl&gt;
1     1     1
2     1     2
3     1     3
4     2     3
5     2     4
6     2     4
```
]

.pull-right[

``` r
tb %&gt;% mutate(diff_b = b - lag(b))
```

```
# A tibble: 6 × 3
      a     b diff_b
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     1     NA
2     1     2      1
3     1     3      1
4     2     3      0
5     2     4      1
6     2     4      0
```
]

---

.pull-left[

``` r
tb %&gt;% 
  group_by(a) %&gt;% 
  mutate(lag_b = lag(b))
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b lag_b
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    NA
2     1     2     1
3     1     3     2
4     2     3    NA
5     2     4     3
6     2     4     4
```
]

.pull-right[

``` r
tb %&gt;% 
  group_by(a) %&gt;% 
  mutate(diff_b = b - lag(b))
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b diff_b
  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     1     NA
2     1     2      1
3     1     3      1
4     2     3     NA
5     2     4      1
6     2     4      0
```
]

---

.pull-left-1[

``` r
tb %&gt;% 
  group_by(a) %&gt;% 
  mutate(lag_b = lag(b))
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b lag_b
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    NA
2     1     2     1
3     1     3     2
4     2     3    NA
5     2     4     3
6     2     4     4
```
]

.pull-right-2[

``` r
tb %&gt;% 
  group_by(a) %&gt;% 
  mutate(growth_b = (b - lag(b)) / lag(b) )
```

```
# A tibble: 6 × 3
# Groups:   a [2]
      a     b growth_b
  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
1     1     1   NA    
2     1     2    1    
3     1     3    0.5  
4     2     3   NA    
5     2     4    0.333
6     2     4    0    
```
]

---

### Application

- Load the bca252 data and assigns bca as its name.

- Create sale_year column. Use the `year` function in `lubridate` package to extract year from `sale_date`.

- Calculate average sale price by act_use_cat and sale_year. Use avg_price as its column name.

- Use avg_price for the name of the resulting tibble.

---


``` r
bca &lt;- read_rds("../Data/bca252.rds")

avg_price &lt;- bca %&gt;% 
  mutate(sale_year = lubridate::year(sale_date)) %&gt;% 
  group_by(act_use_cat, sale_year) %&gt;% 
  summarise(avg_price = mean(price, na.rm=TRUE)) %&gt;% 
	ungroup()
```

---

.scroll-output[

``` r
avg_price
```

```
# A tibble: 52 × 3
   act_use_cat sale_year avg_price
   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;
 1 S/F Res          2000   334017.
 2 S/F Res          2001   330706.
 3 S/F Res          2002   347530.
 4 S/F Res          2003   388934.
 5 S/F Res          2004   453037.
 6 S/F Res          2005   515860.
 7 S/F Res          2006   612594.
 8 S/F Res          2007   707252.
 9 S/F Res          2008   734846.
10 S/F Res          2009   710360.
11 S/F Res          2010   810834.
12 S/F Res          2011   936671.
13 S/F Res          2012   915295.
14 S/F Res          2013   997300.
15 S/F Res          2014  1054603.
16 S/F Res          2015  1197446.
17 S/F Res          2016  1489876.
18 S/F Res          2017  1528183.
19 S/F Res          2018  1562259.
20 S/F Res          2019  1431752.
21 S/F Res          2020  1483322.
22 S/F Res          2021  1745078.
23 S/F Res          2022  2035205.
24 S/F Res          2023  1986565.
25 S/F Res          2024  2027601.
26 S/F Res          2025  1992799.
27 Strata Res       2000   190494.
28 Strata Res       2001   181710.
29 Strata Res       2002   198695.
30 Strata Res       2003   218717.
31 Strata Res       2004   243280.
32 Strata Res       2005   282887.
33 Strata Res       2006   327346.
34 Strata Res       2007   378881.
35 Strata Res       2008   404009.
36 Strata Res       2009   389618.
37 Strata Res       2010   414546.
38 Strata Res       2011   435311.
39 Strata Res       2012   431871.
40 Strata Res       2013   435400.
41 Strata Res       2014   451188.
42 Strata Res       2015   463921.
43 Strata Res       2016   519710.
44 Strata Res       2017   581880.
45 Strata Res       2018   657497.
46 Strata Res       2019   634111.
47 Strata Res       2020   685622.
48 Strata Res       2021   734768.
49 Strata Res       2022   817754.
50 Strata Res       2023   815602.
51 Strata Res       2024   835659.
52 Strata Res       2025   851565.
```
]

---


``` r
ggplot(avg_price, aes(sale_year, avg_price, color=act_use_cat)) + 
  geom_line() + geom_point()
```

![](08_dplyr_3_files/figure-html/unnamed-chunk-18-1.png)&lt;!-- --&gt;

---

Using `avg_price`, calculate price index (= avg_price / avg_price of year 2000) by act_use_cat. Name the output tibble `price_index`.

--


``` r
price_index &lt;- avg_price %&gt;% group_by(act_use_cat) %&gt;% 
  mutate( price_index = avg_price / nth(avg_price, 1))
```

---

.scroll-output[

``` r
price_index
```

```
# A tibble: 52 × 4
# Groups:   act_use_cat [2]
   act_use_cat sale_year avg_price price_index
   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
 1 S/F Res          2000   334017.       1    
 2 S/F Res          2001   330706.       0.990
 3 S/F Res          2002   347530.       1.04 
 4 S/F Res          2003   388934.       1.16 
 5 S/F Res          2004   453037.       1.36 
 6 S/F Res          2005   515860.       1.54 
 7 S/F Res          2006   612594.       1.83 
 8 S/F Res          2007   707252.       2.12 
 9 S/F Res          2008   734846.       2.20 
10 S/F Res          2009   710360.       2.13 
11 S/F Res          2010   810834.       2.43 
12 S/F Res          2011   936671.       2.80 
13 S/F Res          2012   915295.       2.74 
14 S/F Res          2013   997300.       2.99 
15 S/F Res          2014  1054603.       3.16 
16 S/F Res          2015  1197446.       3.58 
17 S/F Res          2016  1489876.       4.46 
18 S/F Res          2017  1528183.       4.58 
19 S/F Res          2018  1562259.       4.68 
20 S/F Res          2019  1431752.       4.29 
21 S/F Res          2020  1483322.       4.44 
22 S/F Res          2021  1745078.       5.22 
23 S/F Res          2022  2035205.       6.09 
24 S/F Res          2023  1986565.       5.95 
25 S/F Res          2024  2027601.       6.07 
26 S/F Res          2025  1992799.       5.97 
27 Strata Res       2000   190494.       1    
28 Strata Res       2001   181710.       0.954
29 Strata Res       2002   198695.       1.04 
30 Strata Res       2003   218717.       1.15 
31 Strata Res       2004   243280.       1.28 
32 Strata Res       2005   282887.       1.49 
33 Strata Res       2006   327346.       1.72 
34 Strata Res       2007   378881.       1.99 
35 Strata Res       2008   404009.       2.12 
36 Strata Res       2009   389618.       2.05 
37 Strata Res       2010   414546.       2.18 
38 Strata Res       2011   435311.       2.29 
39 Strata Res       2012   431871.       2.27 
40 Strata Res       2013   435400.       2.29 
41 Strata Res       2014   451188.       2.37 
42 Strata Res       2015   463921.       2.44 
43 Strata Res       2016   519710.       2.73 
44 Strata Res       2017   581880.       3.05 
45 Strata Res       2018   657497.       3.45 
46 Strata Res       2019   634111.       3.33 
47 Strata Res       2020   685622.       3.60 
48 Strata Res       2021   734768.       3.86 
49 Strata Res       2022   817754.       4.29 
50 Strata Res       2023   815602.       4.28 
51 Strata Res       2024   835659.       4.39 
52 Strata Res       2025   851565.       4.47 
```
]

---


``` r
ggplot(price_index, aes(sale_year, price_index, color=act_use_cat)) + 
  geom_line() + geom_point()
```

![](08_dplyr_3_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;

---

Modify the previous code to calculate price index (= avg_price / avg_price of year 2010) by act_use_cat. Name the output tibble `price_index`.

--


``` r
price_index &lt;- avg_price %&gt;% group_by(act_use_cat) %&gt;% 
  mutate(price_index = avg_price / nth(avg_price, 11))
```

---

.scroll-output[

``` r
price_index
```

```
# A tibble: 52 × 4
# Groups:   act_use_cat [2]
   act_use_cat sale_year avg_price price_index
   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
 1 S/F Res          2000   334017.       0.412
 2 S/F Res          2001   330706.       0.408
 3 S/F Res          2002   347530.       0.429
 4 S/F Res          2003   388934.       0.480
 5 S/F Res          2004   453037.       0.559
 6 S/F Res          2005   515860.       0.636
 7 S/F Res          2006   612594.       0.756
 8 S/F Res          2007   707252.       0.872
 9 S/F Res          2008   734846.       0.906
10 S/F Res          2009   710360.       0.876
11 S/F Res          2010   810834.       1    
12 S/F Res          2011   936671.       1.16 
13 S/F Res          2012   915295.       1.13 
14 S/F Res          2013   997300.       1.23 
15 S/F Res          2014  1054603.       1.30 
16 S/F Res          2015  1197446.       1.48 
17 S/F Res          2016  1489876.       1.84 
18 S/F Res          2017  1528183.       1.88 
19 S/F Res          2018  1562259.       1.93 
20 S/F Res          2019  1431752.       1.77 
21 S/F Res          2020  1483322.       1.83 
22 S/F Res          2021  1745078.       2.15 
23 S/F Res          2022  2035205.       2.51 
24 S/F Res          2023  1986565.       2.45 
25 S/F Res          2024  2027601.       2.50 
26 S/F Res          2025  1992799.       2.46 
27 Strata Res       2000   190494.       0.460
28 Strata Res       2001   181710.       0.438
29 Strata Res       2002   198695.       0.479
30 Strata Res       2003   218717.       0.528
31 Strata Res       2004   243280.       0.587
32 Strata Res       2005   282887.       0.682
33 Strata Res       2006   327346.       0.790
34 Strata Res       2007   378881.       0.914
35 Strata Res       2008   404009.       0.975
36 Strata Res       2009   389618.       0.940
37 Strata Res       2010   414546.       1    
38 Strata Res       2011   435311.       1.05 
39 Strata Res       2012   431871.       1.04 
40 Strata Res       2013   435400.       1.05 
41 Strata Res       2014   451188.       1.09 
42 Strata Res       2015   463921.       1.12 
43 Strata Res       2016   519710.       1.25 
44 Strata Res       2017   581880.       1.40 
45 Strata Res       2018   657497.       1.59 
46 Strata Res       2019   634111.       1.53 
47 Strata Res       2020   685622.       1.65 
48 Strata Res       2021   734768.       1.77 
49 Strata Res       2022   817754.       1.97 
50 Strata Res       2023   815602.       1.97 
51 Strata Res       2024   835659.       2.02 
52 Strata Res       2025   851565.       2.05 
```
]

---



``` r
ggplot(price_index, aes(sale_year, price_index, color=act_use_cat)) + 
  geom_line() + geom_point()
```

![](08_dplyr_3_files/figure-html/unnamed-chunk-24-1.png)&lt;!-- --&gt;

---

Modify the previous code to calculate price growth rate (= (avg_price - avg_price of the previous year)  / avg_price of the previous year) by act_use_cat. Name the output tibble `price_growth`.

--


``` r
price_growth &lt;- avg_price %&gt;% group_by(act_use_cat) %&gt;% 
  mutate( price_growth = (avg_price - lag(avg_price)) / lag(avg_price) )
```

---

.scroll-output[

``` r
price_growth
```

```
# A tibble: 52 × 4
# Groups:   act_use_cat [2]
   act_use_cat sale_year avg_price price_growth
   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
 1 S/F Res          2000   334017.     NA      
 2 S/F Res          2001   330706.     -0.00991
 3 S/F Res          2002   347530.      0.0509 
 4 S/F Res          2003   388934.      0.119  
 5 S/F Res          2004   453037.      0.165  
 6 S/F Res          2005   515860.      0.139  
 7 S/F Res          2006   612594.      0.188  
 8 S/F Res          2007   707252.      0.155  
 9 S/F Res          2008   734846.      0.0390 
10 S/F Res          2009   710360.     -0.0333 
11 S/F Res          2010   810834.      0.141  
12 S/F Res          2011   936671.      0.155  
13 S/F Res          2012   915295.     -0.0228 
14 S/F Res          2013   997300.      0.0896 
15 S/F Res          2014  1054603.      0.0575 
16 S/F Res          2015  1197446.      0.135  
17 S/F Res          2016  1489876.      0.244  
18 S/F Res          2017  1528183.      0.0257 
19 S/F Res          2018  1562259.      0.0223 
20 S/F Res          2019  1431752.     -0.0835 
21 S/F Res          2020  1483322.      0.0360 
22 S/F Res          2021  1745078.      0.176  
23 S/F Res          2022  2035205.      0.166  
24 S/F Res          2023  1986565.     -0.0239 
25 S/F Res          2024  2027601.      0.0207 
26 S/F Res          2025  1992799.     -0.0172 
27 Strata Res       2000   190494.     NA      
28 Strata Res       2001   181710.     -0.0461 
29 Strata Res       2002   198695.      0.0935 
30 Strata Res       2003   218717.      0.101  
31 Strata Res       2004   243280.      0.112  
32 Strata Res       2005   282887.      0.163  
33 Strata Res       2006   327346.      0.157  
34 Strata Res       2007   378881.      0.157  
35 Strata Res       2008   404009.      0.0663 
36 Strata Res       2009   389618.     -0.0356 
37 Strata Res       2010   414546.      0.0640 
38 Strata Res       2011   435311.      0.0501 
39 Strata Res       2012   431871.     -0.00790
40 Strata Res       2013   435400.      0.00817
41 Strata Res       2014   451188.      0.0363 
42 Strata Res       2015   463921.      0.0282 
43 Strata Res       2016   519710.      0.120  
44 Strata Res       2017   581880.      0.120  
45 Strata Res       2018   657497.      0.130  
46 Strata Res       2019   634111.     -0.0356 
47 Strata Res       2020   685622.      0.0812 
48 Strata Res       2021   734768.      0.0717 
49 Strata Res       2022   817754.      0.113  
50 Strata Res       2023   815602.     -0.00263
51 Strata Res       2024   835659.      0.0246 
52 Strata Res       2025   851565.      0.0190 
```
]

---


``` r
ggplot(price_growth, aes(sale_year, price_growth, color=act_use_cat)) + 
  geom_line() + geom_point()
```

![](08_dplyr_3_files/figure-html/unnamed-chunk-27-1.png)&lt;!-- --&gt;

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
  "ratio": "16:9",
  "highlightStyle": "github",
  "highlightLines": true,
  "countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
